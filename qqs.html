<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>請求書</title>

<style>
/* ===== 全局重置 & 打印控制 ===== */
@page {
    size: A4;
    margin: 15mm;
}

body {
    font-family: "Hiragino Kaku Gothic ProN", Meiryo, Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
}

h1.title {
    text-align: center;
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 30px;
}

.form-row {
    display: flex;
    align-items: flex-start;
    margin-bottom: 8px;
}

.form-row label {
    width: 140px;
    font-weight: bold;
    padding-top: 6px;
}

input, select, textarea {
    flex: 1;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    font-size: 14px;
}

textarea {
    resize: vertical;
    min-height: 60px;
}

/* ----- 使取引先情報的两个输入框大小一致 ----- */
#clientName, #clientAddress {
    width: 100%;              /* 与父容器同宽 */
    height: 60px;             /* 固定相同高度 */
    padding: 8px 10px;
    box-sizing: border-box;   /* 高度包含内边距和边框 */
    font-size: 15px;
    margin-bottom: 8px;       /* 两个框之间的间距 */
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    resize: vertical;         /* 地址框可垂直缩放，会社名也允许（若输入多行） */
}

/* 保持其他输入框原有样式不受影响 */
.form-row input, .form-row select, .form-row textarea {
    height: auto;             /* 取消对.form-row内部的高度影响 */
    min-height: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
}

.right {
    width: 100%;
    margin-top: 10px;
    text-align: right;
    padding-right: 20px;
}

/* ===== 請求書本体 ===== */
.invoice {
    width: 100%;
    max-width: 100%;
    margin: 40px auto;
    background: #fff;
    border: 2px solid #000;
    padding: 20px 25px;
    box-sizing: border-box;
    font-size: 14px;
    line-height: 1.5;
}

.invoice h1.title {
    font-size: 32px;
    margin-top: 0;
    margin-bottom: 20px;
    letter-spacing: 1px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 20px;
}

.box {
    flex: 2;
    min-width: 200px;
}

.company-info {
    position: relative;
    padding-right: 2.8cm;
    margin-left: auto;
    width: auto;
    max-width: 55%;
    background: #fff;
    word-break: break-word;
    text-align: left;
}

.stamp {
    position: absolute;
    right: 0;
    top: 0;
    width: 2.2cm;
    height: 2.2cm;
    object-fit: cover;
    border: 1px solid #999;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.address-wrap {
    display: block;
    word-break: break-all;
    line-height: 1.6;
    margin-bottom: 4px;
    white-space: pre-wrap;
}

.amount-box {
    font-size: 22px;
    font-weight: bold;
    margin: 20px 0 10px;
    background: #f0f0f0;
    padding: 10px 15px;
    border-left: 6px solid #333;
}

.summary-area {
    width: 100%;
    display: flex;
    justify-content: flex-end;
    margin: 15px 0;
}

.summary-box {
    width: 280px;
    background: #f9f9f9;
    padding: 12px 18px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 16px;
}

.summary-row span:last-child {
    min-width: 120px;
    text-align: right;
    font-weight: 500;
}

#invoiceTable {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 14px;
}

#invoiceTable th {
    background: #eaeaea;
    font-weight: bold;
    padding: 10px 6px;
}

#invoiceTable td {
    padding: 8px 6px;
}

#i_bank, #i_remark {
    display: block;
    background: #fafafa;
    padding: 8px 12px;
    border: 1px dashed #aaa;
    margin: 8px 0 15px;
    border-radius: 4px;
    line-height: 1.6;
    white-space: pre-wrap;
}

hr {
    margin: 20px 0;
    border: none;
    border-top: 2px solid #333;
}

/* ===== 打印专用 ===== */
@media print {
    body * {
        visibility: hidden;
    }
    #invoice, #invoice * {
        visibility: visible;
    }
    #invoice {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        border: none;
        padding: 15px 20px;
        margin: 0;
        background: #fff;
        font-size: 13px;
    }
    #invoice h1.title {
        font-size: 28px;
    }
    #invoice .amount-box {
        font-size: 20px;
        background: none;
        border-left: 4px solid #333;
    }
    #invoice .stamp {
        border: 1px solid #333;
        box-shadow: none;
    }
    #invoice .summary-box {
        background: none;
        border: 1px solid #333;
    }
    #invoice table th {
        background: #ddd !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

/* ===== 按钮样式 ===== */
button {
    background: #0066cc;
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 30px;
    font-size: 14px;
    cursor: pointer;
    margin: 5px 5px 0 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: 0.2s;
}

button:hover {
    background: #004999;
}

h3 {
    margin: 25px 0 10px;
    border-left: 5px solid #0066cc;
    padding-left: 12px;
}

.company-info strong {
    font-size: 15px;
}

.company-info span {
    font-size: 13px;
}

#i_myAddress, #i_clientAddress {
    white-space: pre-wrap;
}

#subTotal, #taxTotal, #grandTotal, #displayTotal {
    font-weight: bold;
}
</style>
</head>
<body>

<h1 class="title">請求書</h1>

<h3>取引先情報</h3>
<input id="clientName" placeholder="会社名">
<textarea id="clientAddress" placeholder="住所" rows="2"></textarea>

<h3>請求書情報</h3>

<div class="form-row">
<label>請求書番号</label>
<input id="invoiceNo">
</div>

<div class="form-row">
<label>請求日</label>
<input type="date" id="invoiceDate">
</div>

<div class="form-row">
<label>支払い期限</label>
<input type="date" id="dueDate">
</div>

<div class="form-row">
<label>画像アップロード</label>
<input type="file" id="imageUpload" accept="image/*">
</div>

<br>

<div>
<canvas id="cropCanvas" style="border:1px solid #ccc; max-width:300px;"></canvas><br>
<button onclick="cropImage()">会社ロゴ確認</button>
</div>

<div class="amount-box">
ご請求金額：<span id="displayTotal">0円</span>
</div>

<h3>商品明細</h3>

<table id="itemTable">
<tr>
<th>商品名</th>
<th>単価</th>
<th>数量</th>
<th>消費税</th>
<th>価格</th>
</tr>
</table>

<button onclick="addRow()">＋ 商品追加</button>

<div class="right">
小計：<span id="subTotal">0円</span><br>
消費税：<span id="taxTotal">0円</span><br>
<strong>合計：<span id="grandTotal">0円</span></strong>
</div>

<hr>

<h3>我方会社情報</h3>

<div class="form-row">
<label>会社名</label>
<input id="myCompany">
</div>

<div class="form-row">
<label>登録番号</label>
<input id="regNumber">
</div>

<div class="form-row">
<label>住所</label>
<textarea id="myAddress" placeholder="住所" rows="2"></textarea>
</div>

<div class="form-row">
<label>電話</label>
<input id="myPhone">
</div>

<div class="form-row">
<label>振込先</label>
<textarea id="bankInfo" placeholder="振込先" rows="2"></textarea>
</div>

<div class="form-row" style="margin-top:20px;">
<label>備考</label>
<textarea id="remark" rows="3" style="flex:1;"></textarea>
</div>

<br>
<button onclick="createInvoice()">請求書を反映</button>
<button onclick="downloadPDF()">PDF保存</button>
<button onclick="saveCompanyInfo()">我方会社情報を保存</button>


<!-- 請求書プレビュー -->
<div id="invoice" class="invoice">

<h1 class="title">請求書</h1>

<div class="header">

<div class="box">
<strong id="i_client"></strong><br>
<span id="i_clientAddress" class="address-wrap"></span><br>
御中
</div>

<div class="company-info">

<strong id="i_myCompany"></strong><br>
登録番号：<span id="i_reg"></span><br>
<span id="i_myAddress" class="address-wrap"></span><br>
TEL：<span id="i_phone"></span><br><br>

請求書番号：<span id="i_no"></span><br>
請求日：<span id="i_date"></span><br>
支払い期限：<span id="i_due"></span>

<img id="i_image" class="stamp" alt="印">

</div>

</div>

<hr>

<div class="amount-box">
ご請求金額：<span id="i_displayTotal"></span>
</div>

<table id="invoiceTable">
<tr>
<th>商品名</th>
<th>単価</th>
<th>数量</th>
<th>価格</th>
</tr>
</table>

<hr>

<div class="summary-area">
<div class="summary-box">
<div class="summary-row">
<span>小計：</span>
<span id="i_sub"></span>
</div>
<div class="summary-row">
<span>消費税：</span>
<span id="i_tax"></span>
</div>
<div class="summary-row" style="font-weight:bold;">
<span>合計：</span>
<span id="i_total"></span>
</div>
</div>
</div>

<hr>

<strong>振込先</strong><br>
<span id="i_bank" style="white-space: pre-wrap;"></span>

<br><br>

<strong>備考</strong><br>
<span id="i_remark" class="address-wrap"></span>

</div>

<script>
let originalImage = new Image();
let cropCanvas = document.getElementById("cropCanvas");
let ctx = cropCanvas.getContext("2d");

document.getElementById("imageUpload").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(event){
        originalImage.onload = function(){
            cropCanvas.width = 300;
            cropCanvas.height = 300;
            ctx.drawImage(originalImage, 0, 0, 300, 300);
        }
        originalImage.src = event.target.result;
    };
    reader.readAsDataURL(file);
});

function cropImage(){
    const size = 83;
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = size;
    tempCanvas.height = size;
    const tctx = tempCanvas.getContext("2d");
    tctx.drawImage(cropCanvas, 0, 0, size, size);
    document.getElementById("i_image").src = tempCanvas.toDataURL("image/png");
}

function yen(num){
    return (num || 0).toLocaleString("ja-JP") + "円";
}

function calculate(){
    let sub=0, tax=0;
    [...itemTable.rows].slice(1).forEach(r=>{
        const p=+r.querySelector(".price")?.value || 0;
        const q=+r.querySelector(".qty")?.value || 0;
        const t=+r.querySelector(".tax")?.value || 0;
        const a=p*q;
        r.querySelector(".amount").textContent=yen(a);
        sub+=a;
        tax+=Math.floor(a*t);
    });
    subTotal.textContent=yen(sub);
    taxTotal.textContent=yen(tax);
    const total=sub+tax;
    grandTotal.textContent=yen(total);
    displayTotal.textContent=yen(total);
}

function addRow(){
    const r=itemTable.insertRow();
    r.innerHTML=`
    <td><input class="name"></td>
    <td><input type="number" class="price"></td>
    <td><input type="number" class="qty"></td>
    <td>
        <select class="tax">
            <option value="0.08">8%</option>
            <option value="0.10" selected>10%</option>
        </select>
    </td>
    <td class="amount">0円</td>`;
    r.querySelectorAll("input,select").forEach(e=>e.oninput=calculate);
}

function createInvoice(){
    calculate();
    i_client.textContent=clientName.value;
    i_clientAddress.textContent=clientAddress.value;
    i_myCompany.textContent=myCompany.value;
    i_reg.textContent=regNumber.value;
    i_myAddress.textContent=myAddress.value;
    i_phone.textContent=myPhone.value;
    i_no.textContent=invoiceNo.value;
    i_date.textContent=invoiceDate.value;
    i_due.textContent=dueDate.value;
    i_displayTotal.textContent=displayTotal.textContent;

    invoiceTable.innerHTML=`<tr>
    <th>商品名</th><th>単価</th><th>数量</th><th>価格</th></tr>`;

    [...itemTable.rows].slice(1).forEach(r=>{
        invoiceTable.insertRow().innerHTML=`
        <td>${r.querySelector(".name").value}</td>
        <td>${yen(+r.querySelector(".price").value)}</td>
        <td>${r.querySelector(".qty").value}</td>
        <td>${r.querySelector(".amount").textContent}</td>`;
    });

    i_sub.textContent=subTotal.textContent;
    i_tax.textContent=taxTotal.textContent;
    i_total.textContent=grandTotal.textContent;
    i_bank.textContent=bankInfo.value;
    i_remark.textContent=remark.value;
}

function downloadPDF(){
    createInvoice();
    window.print();
}

/* 保存我方会社情報 */
function saveCompanyInfo(){
    const data = {
        myCompany: myCompany.value,
        regNumber: regNumber.value,
        myAddress: myAddress.value,
        myPhone: myPhone.value,
        bankInfo: bankInfo.value,
        remark: remark.value
    };
    localStorage.setItem("companyInfo", JSON.stringify(data));
    alert("我方会社情報を保存しました");
}

/* 页面加载时自动恢复 */
window.onload = function(){
    const saved = localStorage.getItem("companyInfo");
    if(saved){
        const data = JSON.parse(saved);
        myCompany.value = data.myCompany || "";
        regNumber.value = data.regNumber || "";
        myAddress.value = data.myAddress || "";
        myPhone.value = data.myPhone || "";
        bankInfo.value = data.bankInfo || "";
        if(document.getElementById("remark")){
            remark.value = data.remark || "";
        }
    }
};
</script>

</body>
</html>